<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Judge Assignment — Firebase Live</title>
<style>
  :root{
    --ring-w: 220px;
    --ring-h: 240px;
    --gap: 16px;
    --bg:#0b1220; --ink:#e6ecff; --muted:#a6b3d1; --accent:#5b8cff; --ok:#5de0a8; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg);display:grid;grid-template-rows:auto 1fr;gap:14px;padding:14px;overflow-x:hidden}
  header{display:grid;grid-template-columns:1fr auto auto auto auto;gap:10px;align-items:center}
  h1{font-size:18px;margin:0;font-weight:800}
  .tname{display:flex;align-items:center;gap:8px}
  .tname input{width:360px;max-width:100%;background:#0b1b3a;color:var(--ink);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px 12px;font-weight:800}
  button,label.btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;background:#1b2848;color:var(--ink)}
  button.primary{background:var(--accent);color:#fff}
  input[type=file]{display:none}
  .meta{color:var(--muted);font-size:13px;margin-left:6px}

  /* Layout: 75% / 25% */
  .stage{display:grid;grid-template-columns:3fr 1fr;gap:14px;min-height:min(82vh,860px)}

  /* LEFT: grid */
  .grid{position:relative;border-radius:12px;background:#0a132a;padding:12px;overflow:auto}
  .grid-mesh{display:grid;gap:var(--gap);grid-auto-rows:var(--ring-h);grid-template-columns:repeat(3,minmax(0,var(--ring-w)))}
  .ring{width:var(--ring-w);height:var(--ring-h);background:#0f1b39;border-radius:14px;padding:10px;display:grid;grid-template-rows:auto auto 1fr;border:1px solid rgba(255,255,255,.08);box-shadow:inset 0 0 0 1px rgba(255,255,255,.04)}
  .ring-title{display:grid;grid-template-columns:auto;gap:6px;align-items:center}
  .ring-id{font-size:15px;font-weight:800;color:#cfe3ff}
  .ring-meta{display:grid;grid-template-columns:1fr;gap:6px}
  .ring-division,.ring-category{background:#0d1633;border:1px solid rgba(255,255,255,.06);color:var(--ink);border-radius:8px;padding:6px 8px;font-weight:700;min-width:0}
  .ring-category{font-weight:800}
  .slots{display:grid;grid-template-rows:repeat(3,1fr);gap:8px;margin-top:6px}
  .slot{position:relative;border-radius:10px;background:rgba(255,255,255,.05);border:1px dashed rgba(255,255,255,.18);display:grid;place-items:center;color:var(--muted);font-size:12px;text-align:center;padding:6px}
  .slot[data-active=true]{outline:2px solid var(--accent);outline-offset:-2px}
  .slot[data-filled=true]{border-style:solid;border-color:rgba(255,255,255,.28);color:#cfe3ff}
  .slot .clear{position:absolute;top:6px;right:6px;width:22px;height:22px;border-radius:6px;background:#1b2848;color:#fff;border:1px solid rgba(255,255,255,.15);font-size:14px;line-height:18px;display:none;cursor:pointer}
  .slot[data-filled=true] .clear{display:inline-grid;place-items:center}

  /* RIGHT: judges */
  aside.tray{position:relative;background:#0d1a36;border-radius:12px;padding:12px;overflow:hidden;display:grid;grid-template-rows:auto auto auto 1fr;gap:10px;min-width:0}
  .tray-header{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .tray-title{font-size:14px;color:var(--muted);font-weight:700}
  .search{display:grid;grid-template-columns:1fr auto;gap:8px}
  .search input{background:#0b1b3a;color:var(--ink);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:8px;font-weight:700}
  .add-form{display:grid;grid-template-columns:1fr 90px 160px auto;gap:8px}
  .add-form input,.add-form select{background:#0b1b3a;color:var(--ink);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:8px;font-weight:700}
  .tray-scroll{position:relative;overflow-y:auto;overflow-x:hidden;border-radius:10px;background:#0b1b3a;padding:10px;min-height:0;scrollbar-gutter:stable both-edges}
  .tray-area{position:relative;min-height:100%;overflow:visible}
  .tile{position:absolute;width:calc(100% - 20px);min-height:66px;border-radius:10px;cursor:grab;user-select:none;touch-action:none;background:linear-gradient(180deg,#b4c5ff,#7da7ff);box-shadow:0 8px 18px rgba(0,0,0,.35),inset 0 0 0 2px rgba(0,0,0,.08);display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center;padding:8px 10px;left:8px;box-sizing:border-box}
  .tile:active{cursor:grabbing}
  .t-name{font-weight:900;color:#0b1024;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .t-rank{font-size:12px;font-weight:700;color:#0b1024;opacity:.85}
  .t-id{font-size:10px;opacity:.8}
  .t-badge{font-size:11px;font-weight:800;background:rgba(255,255,255,.7);color:#0b1024;padding:2px 6px;border-radius:8px;justify-self:end}
  .tile[data-placed=true]{background:linear-gradient(180deg,#7dfcce,#5de0a8)}
  .tile[data-competing=true]{filter:grayscale(1) brightness(.85);box-shadow:0 0 0 2px var(--danger) inset;cursor:not-allowed}

  .hint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="tname">
    <h1>Judge Assignment — Firebase Live</h1>
    <input id="tournamentName" placeholder="Tournament name…"/>
  </div>
  <button id="newBtn" type="button" class="primary">New Rings</button>
  <button id="addJudgeBtn" type="button" class="btn">Add Judge</button>
  <label class="btn" for="csvInput">Import Judges (CSV)</label><input id="csvInput" type="file" accept=".csv"/>
  <div style="display:flex;gap:8px;"><button id="saveBtn" type="button" class="btn">Save</button><button id="loadBtn" type="button" class="btn">Load</button></div>
  <span class="meta" id="meta"></span>
</header>

<div class="stage">
  <div class="grid"><div class="grid-mesh" id="gridMesh"></div></div>

  <aside class="tray">
    <div class="tray-header"><div class="tray-title">Judges (drag →)</div></div>
    <div class="search">
      <input id="searchBox" type="text" placeholder="Search judges by name…"/>
      <button id="clearSearch" class="btn" type="button">Clear</button>
    </div>
    <form class="add-form" id="addForm">
      <input id="addName" type="text" placeholder="Judge name" required/>
      <select id="addRank" title="Rank 1–8">
        <option value="">Rank</option>
        <option>1</option><option>2</option><option>3</option><option>4</option>
        <option>5</option><option>6</option><option>7</option><option>8</option>
      </select>
      <input id="addDivision" type="text" placeholder="Division (optional)"/>
      <button type="submit" class="primary">Add</button>
    </form>
    <div class="tray-scroll"><div class="tray-area" id="trayArea"></div></div>
  </aside>
</div>

<div class="hint">• Pick/load a tournament name to sync live via Firebase. • New Rings clears placements & judges. • Rank is numeric (1–8) and defines eligibility. • Search filters by name.</div>

<script>
/* ---------------- STATE ---------------- */
let rows=0, cols=0, rings=0;
const SLOTS_PER_RING=3;
let slotsOccupied=[];
let tiles=new Map();
let idCounter=1;

const meshEl=document.getElementById('gridMesh');
const trayArea=document.getElementById('trayArea');
const metaEl=document.getElementById('meta');
const csvInput=document.getElementById('csvInput');
const addForm=document.getElementById('addForm');
const addName=document.getElementById('addName');
const addRank=document.getElementById('addRank');     // numeric 1..8
const addDivision=document.getElementById('addDivision');
const searchBox=document.getElementById('searchBox');
const clearSearchBtn=document.getElementById('clearSearch');
const addJudgeBtn=document.getElementById('addJudgeBtn');
const tNameEl=document.getElementById('tournamentName');

/* per-ring data */
let ringDivisions=[];      // raw entered
let ringDivisionsNorm=[];  // normalized
let ringCategories=[];     // 'Tiger','Color','1 Degree','2/3 Degree','4/5 Degree','6+ Degree'
let ringMinRank=[];        // numeric requirement 1..8 minimal rank that can judge

/* ------------- Helpers ------------- */
function normalizeDivision(s){ return (s||'').toString().trim().replace(/\s+/g,'').toUpperCase(); }

/* Category -> minimal rank allowed (your logic w/ rank=eligibility)
   1: Tiger/Color/1°
   2–3: + 2/3°
   4–5: + 4/5°
   6–8: all
*/
function catToMinRank(cat){
  switch((cat||'').toLowerCase()){
    case 'tiger': return 1;
    case 'color': return 1;
    case '1 degree': return 1;
    case '2/3 degree': return 2;
    case '4/5 degree': return 4;
    case '6+ degree': return 6;
    default: return 1;
  }
}
function judgeEligibleFor(cat, rank){
  const min=catToMinRank(cat);
  return (parseInt(rank||0,10) >= min);
}

function parseRank(val){
  if (typeof val === 'number') return Math.max(1, Math.min(8, Math.floor(val)));
  const s=String(val||'').trim();
  if (/^[1-8]$/.test(s)) return parseInt(s,10);
  return 6; // safe default (senior)
}

/* ------------- UI build ------------- */
function newLayout(){
  const rStr=prompt('How many rings?', String(rings||12));
  if (rStr===null) return;
  const n=Math.max(1, parseInt(rStr,10)||0);

  // clear judges & placements
  clearTiles();
  tiles=new Map(); idCounter=1;

  rings=n;
  cols=Math.min(3, Math.ceil(Math.sqrt(rings)));
  rows=Math.ceil(rings/cols);
  renderGrid(rows, cols, rings);
  slotsOccupied=new Array(rings*SLOTS_PER_RING).fill(null);
  ringDivisions=new Array(rings).fill('');
  ringDivisionsNorm=new Array(rings).fill('');
  ringCategories=new Array(rings).fill('Color');
  ringMinRank=new Array(rings).fill(catToMinRank('Color'));

  metaEl.textContent=`Rings: ${rings} · Grid: ${rows}×${cols}`;
  layoutTray();
  if (window.queueSaveFirebase) window.queueSaveFirebase();
}
(function bindNewRings(){
  const btn=document.getElementById('newBtn');
  if (!btn) return;
  btn.onclick=(e)=>{e.preventDefault(); newLayout();};
})();

function renderGrid(r,c,total){
  meshEl.innerHTML='';
  for(let i=0;i<total;i++){
    const ringIdx=i;
    const ring=document.createElement('div'); ring.className='ring';
    const title=document.createElement('div'); title.className='ring-title';
    const idBadge=document.createElement('div'); idBadge.className='ring-id'; idBadge.textContent=`Ring ${ringIdx+1}`;
    title.appendChild(idBadge);

    const meta=document.createElement('div'); meta.className='ring-meta';
    const divInput=document.createElement('input'); divInput.className='ring-division'; divInput.placeholder='Division code (e.g., M451829)';
    divInput.addEventListener('input', ()=> onDivisionChange(ringIdx, divInput.value));
    meta.appendChild(divInput);

    const cat=document.createElement('select'); cat.className='ring-category';
    ['Tiger','Color','1 Degree','2/3 Degree','4/5 Degree','6+ Degree'].forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;cat.appendChild(o);});
    cat.value='Color';
    cat.addEventListener('change', ()=> onCategoryChange(ringIdx, cat.value));
    meta.appendChild(cat);

    const slots=document.createElement('div'); slots.className='slots';
    for(let s=0;s<SLOTS_PER_RING;s++){
      const slot=document.createElement('div'); slot.className='slot'; slot.dataset.ring=ringIdx; slot.dataset.slot=s; slot.textContent=`Judge slot ${s+1}`;
      const clear=document.createElement('button'); clear.className='clear'; clear.type='button'; clear.title='Remove judge'; clear.textContent='×';
      slot.appendChild(clear); slots.appendChild(slot);
    }
    ring.append(title, meta, slots); meshEl.appendChild(ring);
  }
}

/* ------------- ring events ------------- */
function onDivisionChange(ringIdx, code){
  ringDivisions[ringIdx]=code;
  ringDivisionsNorm[ringIdx]=normalizeDivision(code);
  // pop any now-competing judge
  for(let s=0;s<SLOTS_PER_RING;s++){
    const idx=ringIdx*SLOTS_PER_RING+s;
    const id=slotsOccupied[idx]; if(!id) continue;
    const t=tiles.get(id);
    if(t && t.divNorm && ringDivisionsNorm[ringIdx] && t.divNorm===ringDivisionsNorm[ringIdx]){
      slotsOccupied[idx]=null; resetSlotUI(idx); returnToTray(t);
    }
  }
  recomputeCompeting();
  updateRingFull(ringIdx);
  layoutTray();
  if (window.queueSaveFirebase) window.queueSaveFirebase();
}
function onCategoryChange(ringIdx, cat){
  ringCategories[ringIdx]=cat;
  ringMinRank[ringIdx]=catToMinRank(cat);
  // pop ineligible
  for(let s=0;s<SLOTS_PER_RING;s++){
    const idx=ringIdx*SLOTS_PER_RING+s; const id=slotsOccupied[idx]; if(!id) continue;
    const t=tiles.get(id); if(!t) continue;
    if(!judgeEligibleFor(cat, t.rankNum)){ slotsOccupied[idx]=null; resetSlotUI(idx); returnToTray(t); }
  }
  updateRingFull(ringIdx);
  layoutTray();
  if (window.queueSaveFirebase) window.queueSaveFirebase();
}

/* ------------- judges ------------- */
function spawnJudge(name, rankNum, division){
  const id=`J${idCounter++}`;
  const el=document.createElement('div'); el.className='tile'; el.dataset.id=id; trayArea.appendChild(el);
  const state={ id, name, rankNum:parseRank(rankNum), division:(division||'').trim(), divNorm:normalizeDivision(division), competing:false, el, placed:false, slotIndex:-1, startLeft:10, startTop:10 };
  tiles.set(id,state);
  el.innerHTML=`<div><div class="t-name">${name||'Unnamed'}</div><div class="t-rank">Rank ${state.rankNum||'?'}</div></div><div class="t-id">${state.division?`<span class='t-badge'>${state.division}</span>`:''}</div>`;
  enableDrag(state);
  recomputeCompeting();
  layoutTray();
}

function returnToTray(tile){ tile.placed=false; tile.slotIndex=-1; tile.el.dataset.placed='false'; }
function layoutTray(){
  const q=(searchBox.value||'').trim().toLowerCase();
  let y=10;
  const parent=trayArea.parentElement; // .tray-scroll
  const styles=getComputedStyle(parent);
  const pL=parseFloat(styles.paddingLeft)||0, pR=parseFloat(styles.paddingRight)||0;
  const usableW=Math.max(0, parent.clientWidth - pL - pR - 20);
  const leftPad=pL+8;
  tiles.forEach(t=>{
    if(t.placed) return;
    const show=!q || (t.name && t.name.toLowerCase().includes(q));
    t.el.style.display=show?'grid':'none';
    if(show){
      t.el.style.width=usableW+'px';
      t.el.style.left=leftPad+'px';
      t.el.style.top=y+'px';
      t.startLeft=10; t.startTop=y;
      y+=(t.el.offsetHeight||66)+10;
    }
  });
}

/* ------------- drag/drop ------------- */
function enableDrag(tile){
  let startX=0,startY=0,originLeft=0,originTop=0,dragging=false;
  const onDown=(e)=>{ e.preventDefault(); tile.el.setPointerCapture(e.pointerId); dragging=true; startX=e.clientX; startY=e.clientY; const r=tile.el.getBoundingClientRect(), p=tile.el.offsetParent.getBoundingClientRect(); originLeft=r.left-p.left; originTop=r.top-p.top; tile.el.style.transition='none'; tile.el.style.zIndex=1000; };
  const onMove=(e)=>{ if(!dragging) return; const dx=e.clientX-startX, dy=e.clientY-startY; tile.el.style.left=originLeft+dx+'px'; tile.el.style.top=originTop+dy+'px'; highlightNearestSlot(e.clientX,e.clientY); };
  const onUp=(e)=>{ if(!dragging) return; dragging=false; tile.el.releasePointerCapture(e.pointerId); tile.el.style.transition='left .12s ease, top .12s ease'; tile.el.style.zIndex=''; const ok=trySnapToNearestSlot(tile,e.clientX,e.clientY); clearSlotHighlights(); if(!ok) bounceBack(tile); };
  tile.el.addEventListener('pointerdown', onDown);
  window.addEventListener('pointermove', onMove);
  window.addEventListener('pointerup', onUp);
}
function highlightNearestSlot(x,y){ clearSlotHighlights(); const s=findBestSlot(x,y); if(s && !slotIsFilled(s)) s.dataset.active='true'; }
function clearSlotHighlights(){ document.querySelectorAll('.slot[data-active=true]').forEach(s=>s.dataset.active='false'); }
function slotIndexFromDataset(slot){ const ring=parseInt(slot.dataset.ring,10); const s=parseInt(slot.dataset.slot,10); return ring*SLOTS_PER_RING+s; }
function slotIsFilled(slot){ const idx=slotIndexFromDataset(slot); return !!slotsOccupied[idx]; }

function trySnapToNearestSlot(tile, clientX, clientY){
  const slot=findBestSlot(clientX, clientY); if(!slot) return false;
  const idx=slotIndexFromDataset(slot), ringIdx=parseInt(slot.dataset.ring,10);

  // division guard
  const code=ringDivisionsNorm[ringIdx]||'';
  if(tile.divNorm && code && tile.divNorm===code){ alert('Judges competing'); return false; }
  // rank guard
  const cat=ringCategories[ringIdx] || 'Color';
  if(!judgeEligibleFor(cat, tile.rankNum)){ alert('Judge rank not eligible for this ring'); return false
